<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>AI Agent</title>
 <style>
   * { box-sizing: border-box; margin: 0; padding: 0; }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
     height: 100vh;
     display: flex;
     flex-direction: column;
     background: #0a0a0a;
     color: #e5e5e5;
   }

   header {
     padding: 16px 20px;
     border-bottom: 1px solid #2a2a2a;
     display: flex;
     justify-content: space-between;
     align-items: center;
   }

   header h1 {
     font-size: 18px;
     font-weight: 600;
   }

   main {
     flex: 1;
     display: flex;
     overflow: hidden;
   }

   /* CHAT SECTION */
   .chat-section {
     flex: 1;
     display: flex;
     flex-direction: column;
     border-right: 1px solid #2a2a2a;
   }

   #messages {
     flex: 1;
     overflow-y: auto;
     padding: 20px;
     display: flex;
     flex-direction: column;
     gap: 12px;
   }

   .msg {
     display: flex;
     gap: 8px;
     max-width: 80%;
   }

   .msg.user {
     margin-left: auto;
     flex-direction: row-reverse;
   }

   .msg div {
     padding: 10px 14px;
     border-radius: 16px;
     font-size: 14px;
     line-height: 1.4;
   }

   .msg.ai div {
     background: #1a1a1a;
     border: 1px solid #2a2a2a;
   }

   .msg.user div {
     background: #2563eb;
     color: white;
   }

   .input-area {
     padding: 16px 20px;
     border-top: 1px solid #2a2a2a;
     display: flex;
     gap: 8px;
   }

   .input-area input {
     flex: 1;
     padding: 12px 16px;
     background: #1a1a1a;
     border: 1px solid #2a2a2a;
     border-radius: 20px;
     font-size: 14px;
     color: #e5e5e5;
     outline: none;
   }

   .input-area input:focus {
     border-color: #2563eb;
   }

   .input-area button {
     padding: 12px 24px;
     background: #2563eb;
     color: white;
     border: none;
     border-radius: 20px;
     font-size: 14px;
     font-weight: 500;
     cursor: pointer;
   }

   .input-area button:disabled {
     opacity: 0.5;
     cursor: not-allowed;
   }

   /* SIDEBAR */
   .sidebar {
     width: 350px;
     display: flex;
     flex-direction: column;
     background: #0f0f0f;
   }

   .section {
     padding: 20px;
     border-bottom: 1px solid #2a2a2a;
   }

   .section h2 {
     font-size: 14px;
     font-weight: 600;
     margin-bottom: 16px;
     color: #888;
     text-transform: uppercase;
     letter-spacing: 0.5px;
   }

   .section textarea,
   .section input {
     width: 100%;
     padding: 10px 12px;
     background: #1a1a1a;
     border: 1px solid #2a2a2a;
     border-radius: 8px;
     font-size: 13px;
     color: #e5e5e5;
     outline: none;
     font-family: inherit;
     margin-bottom: 10px;
   }

   .section textarea {
     resize: none;
     height: 100px;
   }

   .section textarea:focus,
   .section input:focus {
     border-color: #2563eb;
   }

   .section button {
     width: 100%;
     padding: 10px;
     background: #2563eb;
     color: white;
     border: none;
     border-radius: 8px;
     font-size: 13px;
     font-weight: 500;
     cursor: pointer;
   }

   .section button:disabled {
     opacity: 0.5;
     cursor: not-allowed;
   }

   .feedback {
     margin-top: 8px;
     font-size: 12px;
     color: #888;
   }

   .feedback.success {
     color: #22c55e;
   }

   .feedback.error {
     color: #ef4444;
   }

   ::-webkit-scrollbar {
     width: 8px;
   }

   ::-webkit-scrollbar-track {
     background: #0a0a0a;
   }

   ::-webkit-scrollbar-thumb {
     background: #2a2a2a;
     border-radius: 4px;
   }
 </style>
</head>
<body>
 <header>
   <h1>AI Agent</h1>
 </header>
 
 <main>
   <!-- CHAT SECTION -->
   <div class="chat-section">
     <div id="messages">
       <div class="msg ai"><div>Hello! I'm your AI assistant. Ask me anything!</div></div>
     </div>
     <div class="input-area">
       <input id="chatInput" placeholder="Type your message..." />
       <button id="chatBtn">Send</button>
     </div>
   </div>

   <!-- SIDEBAR -->
   <aside class="sidebar">
     <div class="section">
       <h2>Add Knowledge</h2>
       <textarea id="dataText" placeholder="Enter information to add to knowledge base..."></textarea>
       <input id="dataId" placeholder="Optional ID (e.g., doc-123)" />
       <button id="dataBtn">Add Data</button>
       <p id="dataStatus" class="feedback"></p>
     </div>
   </aside>
 </main>

 
<script>
   const backendUrl = "http://localhost:3000";
   
   // Elements
   const chatInput = document.getElementById("chatInput");
   const chatBtn = document.getElementById("chatBtn");
   const messages = document.getElementById("messages");
   const dataText = document.getElementById("dataText");
   const dataId = document.getElementById("dataId");
   const dataBtn = document.getElementById("dataBtn");
   const dataStatus = document.getElementById("dataStatus");

   // Append Message
   function appendToMsg(msgEl, text) {
      msgEl.textContent += text;
      messages.scrollTop = messages.scrollHeight;
    }

  

   // Add message to chat
   function addMsg(text, isUser) {
      const msg = document.createElement("div");
      msg.className = `msg ${isUser ? "user" : "ai"}`;

      const content = document.createElement("div");
      content.textContent = text; // SAFE for streaming
      msg.appendChild(content);

      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;

      return content; // ðŸ‘ˆ RETURN ELEMENT FOR STREAMING
    }


   // Send chat message
   async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  addMsg(text, true);      // user message
  chatInput.value = "";
  chatBtn.disabled = true;

  try {
    const res = await fetch(`${backendUrl}/ask/stream`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: text }),
    });

    if (!res.ok || !res.body) {
      throw new Error("Streaming failed");
    }

    // Create empty AI message
    const aiMsgEl = addMsg("", false);

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");

    let buffer = "";

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      // SSE messages end with \n\n
      const events = buffer.split("\n\n");
      buffer = events.pop();

      for (const event of events) {
        if (event.startsWith("data: ")) {
          const token = event.slice(6);
          appendToMsg(aiMsgEl, token);
        }
      }
    }
  } catch (err) {
    console.error(err);
    addMsg(
      "Connection error. Please check if backend is running.",
      false
    );
  } finally {
    chatBtn.disabled = false;
  }
}


   chatBtn.onclick = sendMessage;
   chatInput.onkeypress = (e) => {
     if (e.key === "Enter" && !e.shiftKey) {
       e.preventDefault();
       sendMessage();
     }
   };

   // Add knowledge to backend
   async function addData() {
     const text = dataText.value.trim();
     const id = dataId.value.trim();
     if (!text) return;

     dataBtn.disabled = true;
     dataStatus.textContent = "Adding...";
     dataStatus.className = "feedback";

     try {
       const res = await fetch(`${backendUrl}/ingest`, {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify({ text, id })
       });
       const data = await res.json();
       dataStatus.textContent = "âœ“ Data added successfully";
       dataStatus.className = "feedback success";
       dataText.value = "";
       dataId.value = "";
     } catch {
       dataStatus.textContent = "âœ— Failed to add data";
       dataStatus.className = "feedback error";
     } finally {
       dataBtn.disabled = false;
     }
   }

   dataBtn.onclick = addData;
 </script>

</body>
</html>